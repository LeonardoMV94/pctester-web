const getTurnstileToken = () => {
    return new Promise((resolve, reject) => {
        const interval = setInterval(() => {
            const token = document.querySelector('.cf-turnstile-response')?.value;
            if (token) {
                clearInterval(interval);
                resolve(token);
            }
        }, 100);

        // Timeout after 5 seconds if the token is not found
        setTimeout(() => {
            clearInterval(interval);
            reject(new Error('Turnstile token retrieval timed out'));
        }, 10000);
    });
};

const submitForm = async(e) => {
    e.preventDefault();

    const name = getInputVal("name");
    const email = getInputVal("email");
    const phone = getInputVal("phone");
    const empresa = getInputVal("empresa");
    const ciudad = getInputVal("ciudad");
    const asunto = getInputVal("asunto");
    const mensaje = getInputVal("mensaje");

    // Obtener el token de Turnstile
    const token = await getTurnstileToken();

    // Crear un objeto con los datos del formulario
    const formData = {
        name,
        email,
        empresa,
        ciudad,
        phone,
        asunto,
        mensaje,
        token
    };

    // Enviar los datos al endpoint de Cloudflare
    fetch('https://pctester-form.contacto-pctester.workers.dev/form', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Success:', data);
        document.getElementById("sendmessage").style.display = "block";
        setTimeout(() => {
            document.getElementById("sendmessage").style.display = "none";
        }, 3000);
        document.getElementById("contactForm").reset();
    })
    .catch(error => {
        console.error('Error:', error);
    });
};

const getInputVal = (id) => document.getElementById(id).value;

document.getElementById("contactForm").addEventListener("submit", submitForm);

const date = new Date();
const day = date.getDate();
const month = date.getMonth() + 1;
const year = date.getFullYear();
const hour = date.getHours();
const min = date.getMinutes();
const sec = date.getSeconds();
const fecha = date.getTime();


// scrollbar
document.addEventListener("scroll", () => {
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    const scrollHeight = (document.documentElement.scrollHeight || document.body.scrollHeight) - document.documentElement.clientHeight;
    const scrollPercent = `${scrollTop / scrollHeight * 100}%`;
    document.getElementById("_progress").style.setProperty("--scroll", scrollPercent);
}, { passive: true });